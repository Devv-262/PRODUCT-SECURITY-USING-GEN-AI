FROM golang:1.22-alpine3.15 AS builder

# Install only the tools needed for building
RUN apk add --no-cache git

WORKDIR /src

# Cache module download
COPY go.mod go.sum ./
RUN go mod download

# Copy source and build the binary
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -ldflags="-s -w" -o /app/appbinary

# ---------- Runtime Stage ----------
FROM alpine:3.15

# 1. Install OS packages with verified fixes and clean cache
RUN apk add --no-cache \
    busybox=1.34.1-r5 \
    openssl=1.1.1t-r2 \
    libretls=3.3.4-r3 && \
    rm -rf /var/cache/apk/*

# 2. Create non‑root user and group
RUN addgroup -S appgroup && \
    adduser -S -G appgroup -u 10001 appuser

# 3. Set working directory
WORKDIR /app

# 4. Copy the compiled binary from builder, set ownership
COPY --from=builder --chown=appuser:appgroup /app/appbinary ./

# 5. Switch to non‑root user
USER appuser

# 6. (Optional) Healthcheck – adjust if the app exposes an HTTP endpoint
# HEALTHCHECK --interval=30s --timeout=5s \
#   CMD wget -qO- http://localhost:8080/health || exit 1

# 7. Entrypoint
ENTRYPOINT ["./appbinary"]